name: Upstream Sync Check

on:
  schedule:
    # Run weekly on Mondays at 08:00 UTC.
    - cron: "0 8 * * 1"
  workflow_dispatch:
    # Allow manual trigger with optional version override.
    inputs:
      version:
        description: "Upstream version to check against (default: from sync.toml)"
        required: false
        type: string

jobs:
  sync-check:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install

      - name: Install project dependencies
        run: uv sync --group dev

      - name: Check latest upstream version
        run: uv run python scripts/sync_upstream.py --check-latest

      - name: Run sync check
        id: sync
        continue-on-error: true
        run: |
          VERSION_ARG=""
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION_ARG="--version ${{ github.event.inputs.version }}"
          fi
          uv run python scripts/sync_upstream.py $VERSION_ARG 2>&1 | tee sync_report.txt

      - name: Create or update issue if drift detected
        if: steps.sync.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('sync_report.txt', 'utf8');
            const date = new Date().toISOString().slice(0, 10);

            // Check if an open issue already exists.
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync',
            });

            if (issues.data.length > 0) {
              // Update existing issue with latest report.
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## Updated sync check (${date})\n\n\`\`\`\n${report}\n\`\`\``,
              });
              console.log(`Updated issue #${issues.data[0].number}`);
            } else {
              // Create new issue.
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Upstream wavesurfer.js API drift detected',
                body: `The weekly sync check found differences between the Python wrapper and upstream wavesurfer.js.\n\n\`\`\`\n${report}\n\`\`\`\n\nRun \`uv run python scripts/sync_upstream.py\` locally for details.`,
                labels: ['upstream-sync'],
              });
              console.log('Created new upstream-sync issue');
            }
